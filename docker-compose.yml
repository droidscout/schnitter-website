services:
  api:
    build:
      context: ./server
      platforms:
        - linux/amd64
    image: droidscout/schnitter-api:1.0.20
    env_file:
      - ./server/.env
    environment:
      - CONTACT_RECEIVER_EMAIL=${CONTACT_RECEIVER_EMAIL:-ralph.loser@posteo.de}
      - FRONTEND_BASE_URL=${FRONTEND_BASE_URL:-http://localhost:8080}
      - THANK_YOU_PAGE_URL=${THANK_YOU_PAGE_URL:-/danke}
      - API_SERVICE_SECRET=${API_SERVICE_SECRET}
      - RATE_LIMIT_WINDOW_MS=${RATE_LIMIT_WINDOW_MS:-60000}
      - RATE_LIMIT_MAX=${RATE_LIMIT_MAX:-10}
      - RECAPTCHA_SECRET_KEY=${RECAPTCHA_SECRET_KEY}
      # SMTP configuration (set for real sending)
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_AUTH_METHOD=${SMTP_AUTH_METHOD:-LOGIN}
      - SMTP_SECURE=${SMTP_SECURE}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - NODE_ENV=${NODE_ENV:-development}
      - TOKEN_TTL_MINUTES=${TOKEN_TTL_MINUTES:-60}
    networks:
      app_net:
        aliases:
          - api
    deploy:
      mode: replicated
      replicas: 1
    restart: unless-stopped

  web:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # Set your Git repository URL here (HTTPS). Example:
        # REPO_URL: https://github.com/your-org/your-repo.git
        REPO_URL: ${REPO_URL}
        # Optional: branch, tag, or commit to checkout (defaults to main)
        REPO_REF: ${REPO_REF:-main}
        # API base URL for frontend; with nginx proxy, use "/api"
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-/api}
        # reCAPTCHA site key for frontend build
        VITE_RECAPTCHA_SITE_KEY: ${VITE_RECAPTCHA_SITE_KEY}
      platforms:
        - linux/amd64
    image: droidscout/schnitter-web:1.0.20
    ports:
      - "8079:80"
    depends_on:
      - api
    networks:
      - app_net
    deploy:
      mode: replicated
      replicas: 1
    restart: unless-stopped

networks:
  app_net:
    driver: overlay

# Usage:
# 1) Create a .env file next to this compose with:
#      REPO_URL=https://github.com/your-org/your-repo.git
#      REPO_REF=main
#      CONTACT_RECEIVER_EMAIL=haustechnik@schnittergbr.de
#      FRONTEND_BASE_URL=http://localhost:8080
#      SMTP_HOST=smtp.example.com
#      SMTP_PORT=587
#      SMTP_SECURE=false
#      SMTP_USER=mailer
#      SMTP_PASS=secret
# 2) Build and run:
#      docker compose up -d --build
# 3) Open http://localhost:8080
